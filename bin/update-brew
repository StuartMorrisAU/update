# Brew for macOS
#
# Caution: major macOS upgrades result in /usr/local ownership reverted
# to root:wheel. We have improved the situation already, but there's one
# last migration you need to do which requires writing permission of /usr/local.
#
#     sudo chown "$(whoami)" /usr/local
#     cd /usr/local
#     git fetch
#     git reset --hard origin/master
#     brew update --force
#
if command -v brew >/dev/null 2>&1; then
  if [[ `whoami` != "root" ]]; then

    # Update the brew repos
    for repo in "$(brew --repo)" "$(brew --repo homebrew/cask)"; do
      pushd "$repo"
      git clean -dfx
      git reset --hard origin/master
      git pull origin master
      popd
    done

    # Update the brew knowledgebase
    brew update

    # As of 2019-04-10, these loops below is the best known simple
    # way to figure out which items are stil outdated, then upgrade
    # each one, one by one, and continuing even if any item fails.

    brew outdated | 
    while read x; do
      brew reinstall --force "homebrew/$x"
    done

    brew outdated --cask | 
    while read x; do
      brew reinstall --force "homebrew/cask/$x"
    done

    brew outdated --cask --greedy --verbose |
    grep -v '(latest)' |
    awk '{print $1}' |
    while read x; do
      brew reinstall --force "homebrew/cask/$x"
    done

    # Upgrade all the normal applications.
    brew upgrade

    # Upgrade all the normal applications, plus use greedy flag.
    brew upgrade --greedy

    # Upgrade all the cask applications.
    brew upgrade --cask

    # Upgrade all the cask applications, plus use greedy flag.
    brew upgrade --cask --greedy

    # Cleanup
    brew cleanup
  fi
fi

#!/bin/sh
set -euf

# Run update-cargo-toml with manifests:
#
#     $XDG_CONFIG_HOME/update-git-pull-manifests/*
#     $HOME/update-git-pull-manifests/*
#
# For example:
#
#     ~/update-git-pull-manifests/foo.txt
#     ~/update-git-pull-manifests/bar.txt
#
# Each manifest file is simply a list of local project directories.
# The program skips lines that are comments (begin with #) or blank.

update_cargo_toml_manifests() {
    manifests_to_lines "${XDG_CONFIG_HOME:-$HOME/.config}/update-cargo-toml-manifests" |
    while read -r line; do
        cd "$line" 2>/dev/null && 
        update_cargo_toml
    done
}

update_cargo_toml() {
    # Rust cargo package manager
    if command -v cargo >/dev/null 2>&1; then
        # Is this command running inside a cargo project?
        if cargo check>/dev/null 2>&1; then 
            cargo update --aggressive
            cargo check --all-targets
            cargo build --all-targets
            cargo test --all-targets --no-run
            # Is "cargo upgrade" available?
            # If yes, then upgrade the Cargo.toml file.
            if cargo upgrade --help>/dev/null 2>&1; then
                cargo upgrade --recursive true
            fi
        fi
    fi
}

manifests_to_lines() {
    find "$1" -type f -exec cat {} \; 2>/dev/null |
    grep -v "^#" |
    grep -v "^[:space:]*$"
}

update_cargo_toml_manifests
